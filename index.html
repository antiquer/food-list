<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大家的美食口袋名單 (雲端同步版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff6b6b;
            --secondary-color: #4ecdc4;
            --bg-color: #f7f9fc;
            --text-color: #2d3436;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        /* Loading Overlay */
        #loading {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Header */
        header {
            background-color: var(--card-bg);
            padding: 20px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 90;
        }

        h1 { margin: 0 0 15px 0; font-size: 1.4rem; text-align: center; }

        .tabs-wrapper { overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .tabs { display: inline-flex; gap: 10px; padding: 0 10px; }
        
        .tab-btn {
            border: none; background: #eee; padding: 8px 18px; border-radius: 20px;
            cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease;
        }
        .tab-btn.active { background-color: var(--primary-color); color: white; }

        /* Container */
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }

        .restaurant-card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            animation: fadeIn 0.4s ease;
        }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .store-name { font-size: 1.2rem; font-weight: 700; margin: 0; }
        .category-tag { font-size: 0.75rem; background: #e1f5fe; color: #0288d1; padding: 3px 8px; border-radius: 6px; }

        .info-row { display: flex; align-items: flex-start; margin-bottom: 8px; font-size: 0.9rem; color: #636e72; }
        .info-row i { width: 24px; color: var(--primary-color); margin-top: 3px; }
        .info-row a { color: #636e72; text-decoration: none; border-bottom: 1px dotted #b2bec3; }

        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 10px; border-radius: 10px; text-align: center; text-decoration: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; border: none; }
        .btn-booking { background-color: var(--secondary-color); color: white; }
        .btn-disabled { background-color: #b2bec3; color: white; pointer-events: none; }
        .btn-menu { background-color: #f1f2f6; color: var(--text-color); }

        .menu-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #fafafa; border-radius: 0 0 10px 10px; margin-top: 5px; }
        .menu-inner { padding: 15px; border-top: 1px dashed #dfe6e9; }
        .menu-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }

        /* FAB & Modal */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background-color: var(--primary-color); color: white; border-radius: 50%; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 99; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; max-height: 85vh; overflow-y: auto; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; }
        .btn-submit { width: 100%; background: var(--primary-color); color: white; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn-submit:disabled { background: #ccc; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <p>正在同步雲端美食...</p>
</div>

<header>
    <h1>大家的美食口袋名單 <i class="fas fa-utensils"></i></h1>
    <div class="tabs-wrapper">
        <div class="tabs" id="category-tabs"></div>
    </div>
</header>

<div class="container" id="restaurant-list"></div>

<div class="fab" onclick="openModal()"><i class="fas fa-plus"></i></div>

<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="margin:0">分享新店家</h2>
            <i class="fas fa-times" onclick="closeModal()" style="cursor:pointer; font-size:1.2rem"></i>
        </div>
        <form id="addForm" onsubmit="submitRestaurant(event)">
            <div class="form-group"><label class="form-label">店名 *</label><input type="text" id="inputName" class="form-input" required></div>
            <div class="form-group">
                <label class="form-label">分類 *</label>
                <select id="inputCategory" class="form-input">
                    <option value="漢堡">漢堡</option><option value="咖哩/甜點">咖哩/甜點</option>
                    <option value="餐酒館">餐酒館</option><option value="日式">日式</option>
                    <option value="咖啡廳">咖啡廳</option><option value="小吃">小吃</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">地址</label><input type="text" id="inputAddress" class="form-input"></div>
            <div class="form-group"><label class="form-label">電話</label><input type="text" id="inputPhone" class="form-input"></div>
            <div class="form-group"><label class="form-label">營業時間</label><input type="text" id="inputHours" class="form-input"></div>
            <div class="form-group"><label class="form-label">訂位連結 (選填)</label><input type="url" id="inputBooking" class="form-input"></div>
            <div class="form-group"><label class="form-label">菜單 (範例: 牛肉堡 $200)</label><textarea id="inputMenu" class="form-input" style="height:100px"></textarea></div>
            <button type="submit" id="submitBtn" class="btn-submit">送出資料</button>
        </form>
    </div>
</div>

<script>
    // ==========================================
    // 請在這裡貼上你的 Google Apps Script 網址
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbwyQA1FSArxS-CH72cnTNmkiJF3FOtD6uIZhLdtrEJzha5HatFLTooHQbIhXwyM0UGL/exec"; 
    // 例如: "https://script.google.com/macros/s/AKfycbx.../exec"

    let restaurants = [];
    let currentCategory = 'all';

    // 啟動載入
    window.onload = function() {
        if(API_URL === "YOUR_GOOGLE_SCRIPT_URL") {
            alert("請先修改程式碼中的 API_URL 為您的 Apps Script 網址！");
            document.getElementById('loading').style.display = 'none';
            return;
        }
        fetchData();
    };

    // 從 Google Sheet 抓取資料
    function fetchData() {
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                // 資料反轉，讓最新的顯示在最上面
                restaurants = data.reverse(); 
                renderTabs();
                renderList();
                document.getElementById('loading').style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                alert("讀取資料失敗，請檢查網路或設定");
                document.getElementById('loading').style.display = 'none';
            });
    }

    function renderTabs() {
        const tabsContainer = document.getElementById('category-tabs');
        const categories = ['all', ...new Set(restaurants.map(r => r.category))];
        let html = '';
        categories.forEach(cat => {
            const displayName = cat === 'all' ? '全部' : cat;
            const activeClass = cat === currentCategory ? 'active' : '';
            html += `<button class="tab-btn ${activeClass}" onclick="filterFood('${cat}')">${displayName}</button>`;
        });
        tabsContainer.innerHTML = html;
    }

    function renderList() {
        const listContainer = document.getElementById('restaurant-list');
        listContainer.innerHTML = '';
        
        const filtered = currentCategory === 'all' ? restaurants : restaurants.filter(r => r.category === currentCategory);

        filtered.forEach((r, index) => {
            // 處理菜單文字轉 HTML
            let menuHtml = '';
            if(r.menu) {
                menuHtml = `<div id="menu-${index}" class="menu-content"><div class="menu-inner">`;
                const lines = r.menu.split('\n');
                lines.forEach(line => {
                    if(line.trim()) {
                        menuHtml += `<div class="menu-item"><span>${line}</span></div>`;
                    }
                });
                menuHtml += `</div></div>`;
            }

            const bookingBtn = r.booking && r.booking.startsWith('http')
                ? `<a href="${r.booking}" target="_blank" class="btn btn-booking">訂位</a>`
                : `<div class="btn btn-disabled">現場候位</div>`;
            
            const mapLink = `http://googleusercontent.com/maps.google.com/6{encodeURIComponent(r.name + ' ' + r.address)}`;

            const card = document.createElement('div');
            card.className = 'restaurant-card';
            card.innerHTML = `
                <div class="card-header">
                    <h3 class="store-name">${r.name}</h3>
                    <span class="category-tag">${r.category}</span>
                </div>
                <div class="info-row"><i class="fas fa-map-marker-alt"></i><a href="${mapLink}" target="_blank">${r.address}</a></div>
                <div class="info-row"><i class="fas fa-phone"></i><a href="tel:${r.phone}">${r.phone}</a></div>
                <div class="info-row"><i class="far fa-clock"></i><span>${r.hours}</span></div>
                <div class="actions">
                    ${bookingBtn}
                    <div class="btn btn-menu" onclick="toggleMenu('menu-${index}')">菜單 ▼</div>
                </div>
                ${menuHtml}
            `;
            listContainer.appendChild(card);
        });
    }

    window.filterFood = function(cat) {
        currentCategory = cat;
        renderTabs();
        renderList();
    }

    window.toggleMenu = function(id) {
        const menu = document.getElementById(id);
        if(!menu) return;
        if (menu.style.maxHeight) {
            menu.style.maxHeight = null;
        } else {
            menu.style.maxHeight = menu.scrollHeight + "px";
        }
    }

    // Modal & Form Logic
    window.openModal = () => document.getElementById('addModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('addModal').style.display = 'none';
    
    // 送出新餐廳
    window.submitRestaurant = function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "資料上傳中...";

        const formData = {
            name: document.getElementById('inputName').value,
            category: document.getElementById('inputCategory').value,
            address: document.getElementById('inputAddress').value,
            phone: document.getElementById('inputPhone').value,
            hours: document.getElementById('inputHours').value,
            booking: document.getElementById('inputBooking').value,
            menu: document.getElementById('inputMenu').value
        };

        // 使用 fetch 送出 POST 請求 (no-cors 模式)
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(formData)
        })
        .then(() => {
            alert("新增成功！資料已同步。");
            closeModal();
            document.getElementById('addForm').reset();
            fetchData(); // 重新讀取資料
        })
        .catch(err => {
            console.error(err);
            alert("上傳失敗");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }
</script>
</body>
</html>
